- name: livegrep config file
  template:
    src: livegrep.json.j2
    dest: /home/livegrep/livegrep.json
  notify: reload livegrep-web

- name: livegrep-web.service
  copy:
    src: livegrep-web.service
    dest: /etc/systemd/system/livegrep-web.service
    owner: root
    group: root

- name: livegrep-web.conf
  copy:
    src: livegrep-web.init
    dest: /etc/init/livegrep-web.conf
    owner: root
    group: root

- name: start livegrep-web
  service:
    name: livegrep-web
    state: started

- name: livegrep nginx site
  template:
    dest: /etc/nginx/conf.d/livegrep.com.conf
    src: livegrep.com.conf.j2
  notify: reload nginx

- name: fetch livegrep certificates
  shell: |
    sudo -u letsencrypt "AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION" sh -c '
      credstash -r us-west-2 get livegrep-web/certs/{{livegrep_domain}} \
        role=livegrep-web domain={{livegrep_domain}} | \
        openssl base64 -d | \
        tar -C /etc/letsencrypt -xz
    '
  args:
    creates: '/etc/letsencrypt/live/{{livegrep_domain}}'

- name: configure DNS
  route53:
    command: create
    type: A
    zone: livegrep.com
    record: '{{livegrep_domain}}'
    ttl: 60
    value: '{{ansible_ec2_public_ipv4}}'
    overwrite: true
